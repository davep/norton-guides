





<!DOCTYPE html>
<html>

  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <meta name="generator" content="ng2web v1.1.0 (ngdb v1.1.0)">
    <link rel="stylesheet" type="text/css" href="xms30-style.css">
    <title>XMS Specification  (version 3.0) » XMS » Overview</title>
    <meta name="description" content="XMS Specification  (version 3.0)">
    <link rel="prev" href="xms30-10907.html">
    <link rel="next" href="xms30-17579.html">
    
  </head>

  <body>

    <header>
      <nav class="box">
        <ul>
          

<li><a href="xms30-about.html">About</a></li>


          

<li><a href="xms30-10907.html">Previous</a></li>


          

<li><a href="index.html">Up</a></li>


          

<li><a href="xms30-17579.html">Next</a></li>


        </ul>
      </nav>
    </header>

    <section>

      <nav class="menu box">
        <ul>
            <li>XMS</li>
            <ul>
              <li><a href="index.html">Overview</a></li>
              <li><a href="xms30-18951.html">XMS API</a></li>
              
            </ul>
        </ul>
      </nav>

      <article class="box">
        
  
  
    <pre class="entry"><span class="line"><span class="ngb">IMPLEMENTATION OF CODE FOR HOOKING THE XMS DRIVER</span></span><br /><span class="line"></span><br /><span class="line">In order to support the hooking of the XMS driver by multiple pieces of</span><br /><span class="line">code, the following code sample should be followed. Use of other methods</span><br /><span class="line">for hooking the XMS driver will not work in many cases. This method is</span><br /><span class="line">the official supported one.</span><br /><span class="line"></span><br /><span class="line">The basic strategy is:</span><br /><span class="line"></span><br /><span class="line">    Find the XMS driver header which has the &#34;near jump&#34; dispatch.</span><br /><span class="line"></span><br /><span class="line">    Patch the near jump to a FAR jump which jumps to my HOOK XMS driver</span><br /><span class="line">    header.</span><br /><span class="line"></span><br /><span class="line">NOTES:</span><br /><span class="line"></span><br /><span class="line">    This architecture allows the most recent HOOKer to undo his XMS</span><br /><span class="line">    driver hook at any time without having to worry about damaging a</span><br /><span class="line">    &#34;hook chain&#34;.</span><br /><span class="line"></span><br /><span class="line">    This architecture allows the complete XMS hook chain to be</span><br /><span class="line">    enumerated at any time. There are no &#34;hidden hooks&#34;.</span><br /><span class="line"></span><br /><span class="line">    This architecture allows the HOOKer to not have to worry about</span><br /><span class="line">    installing an &#34;INT 2F hook&#34; to hook the AH=43h INT 2Fs handled by</span><br /><span class="line">    the XMS driver. The base XMS driver continues to be the only one</span><br /><span class="line">    installed on INT 2Fh AH=43h.</span><br /><span class="line"></span><br /><span class="line">    This avoids all of the problems of undoing a software interrupt</span><br /><span class="line">    hook.</span><br /><span class="line"></span><br /><span class="line">  ;</span><br /><span class="line">  ; When I wish to CHAIN to the previous XMS driver, I execute a FAR JMP</span><br /><span class="line">  ; to the address stored in this DWORD.</span><br /><span class="line">  ;</span><br /><span class="line"></span><br /><span class="line">  PrevXMSControlAddr    dd      ?</span><br /><span class="line"></span><br /><span class="line">  ;</span><br /><span class="line">  ; The next two data items are needed ONLY if I desire to be able to undo</span><br /><span class="line">  ; my XMS hook.</span><br /><span class="line">  ; PrevXMSControlJmpVal stores the previos XMS dispatch near jump offset</span><br /><span class="line">  ; value that is used to unhook my XMS hook</span><br /><span class="line">  ; PrevXMSControlBase stores the address of the XMS header that I hooked</span><br /><span class="line">  ;</span><br /><span class="line"></span><br /><span class="line">  PrevXMSControlBase    dd      ?</span><br /><span class="line">  PrevXMSControlJmpVal  db      ?</span><br /><span class="line"></span><br /><span class="line">  ;</span><br /><span class="line">  ; This is MY XMS control header.</span><br /><span class="line">  ;</span><br /><span class="line"></span><br /><span class="line">  MyXMSControlFunc proc FAR</span><br /><span class="line"></span><br /><span class="line">        jmp     short XMSControlEntry</span><br /><span class="line">        nop</span><br /><span class="line">        nop</span><br /><span class="line">        nop</span><br /><span class="line"></span><br /><span class="line">  XMSControlEntry:</span><br /><span class="line"></span><br /><span class="line">  ......</span><br /><span class="line"></span><br /><span class="line">  Chain:</span><br /><span class="line"></span><br /><span class="line">        jmp     cs:[PrevXMSControlAddr]</span><br /><span class="line"></span><br /><span class="line">  MyXMSControlFunc endp</span><br /><span class="line"></span><br /><span class="line"></span><br /><span class="line">  .......</span><br /><span class="line">  ;</span><br /><span class="line">  ; This is the code which installs my hook into the XMS driver.</span><br /><span class="line">  ;</span><br /><span class="line">  ;</span><br /><span class="line">  ; See if there is an XMS driver to hook</span><br /><span class="line">  ;</span><br /><span class="line"></span><br /><span class="line">        mov     ax,4300h</span><br /><span class="line">        int     2Fh</span><br /><span class="line">        cmp     al,80h</span><br /><span class="line">        jne     NoXMSDrvrToHookError</span><br /><span class="line"></span><br /><span class="line">  ;</span><br /><span class="line">  ; Get the current XMS driver Control address</span><br /><span class="line">  ;</span><br /><span class="line"></span><br /><span class="line">        mov     ax,4310h</span><br /><span class="line">        int     2Fh</span><br /><span class="line"></span><br /><span class="line">  NextXMSHeader:</span><br /><span class="line"></span><br /><span class="line">        mov     word ptr [PrevXMSControlAddr+2],es</span><br /><span class="line">        mov     word ptr [PrevXMSControlBase+2],es</span><br /><span class="line">        mov     word ptr [PrevXMSControlBase],bx</span><br /><span class="line">        mov     cx,word ptr es:[bx]</span><br /><span class="line">        cmp     cl,0EBh                         ; Near JUMP</span><br /><span class="line">        je      ComputeNearJmp</span><br /><span class="line">        cmp     cl,0EAh                         ; Far JUMP</span><br /><span class="line">        jne     XMSDrvrChainMessedUpError</span><br /><span class="line"></span><br /><span class="line">  ComputeFarJmp:</span><br /><span class="line"></span><br /><span class="line">        mov     si,word ptr es:[bx+1]           ; Offset of jump</span><br /><span class="line">        mov     es,word ptr es:[bx+1+2]         ; Seg of jump</span><br /><span class="line">        mov     bx,si</span><br /><span class="line">        jmp     short NextXMSHeader</span><br /><span class="line"></span><br /><span class="line">  ComputeNearJmp:</span><br /><span class="line"></span><br /><span class="line">        cmp     word ptr es:[bx+2],9090h        ; Two NOPs?</span><br /><span class="line">        jne     XMSDrvrChainMessedUpError       ; No</span><br /><span class="line">        cmp     byte ptr es:[bx+4],90h          ; Total of 3 NOPs?</span><br /><span class="line">        jne     XMSDrvrChainMessedUpError       ; No</span><br /><span class="line">        mov     di,bx                           ; Save pointer to header</span><br /><span class="line">        xor     ax,ax</span><br /><span class="line">        mov     al,ch                           ; jmp addr of near jump</span><br /><span class="line">        mov     [PrevXMSControlJmpVal],al</span><br /><span class="line">        add     ax,2                            ; NEAR JMP is 2 byte instruction</span><br /><span class="line">        add     bx,ax                           ; Target of jump</span><br /><span class="line">        mov     word ptr [PrevXMSControlAddr],bx</span><br /><span class="line"></span><br /><span class="line">  ;</span><br /><span class="line">  ; Now INSTALL my XMS HOOK</span><br /><span class="line">  ;</span><br /><span class="line"></span><br /><span class="line">        cli                             ; Disable INTs in case someone calls</span><br /><span class="line">                                        ;       XMS at interrupt time</span><br /><span class="line">        mov     byte ptr es:[di],0EAh   ; Far Immed. JUMP instruction</span><br /><span class="line">        mov     word ptr es:[di+1],offset MyXMSControlFunc</span><br /><span class="line">        mov     word ptr es:[di+3],cs</span><br /><span class="line">        sti</span><br /><span class="line"></span><br /><span class="line">    .....</span><br /><span class="line"></span><br /><span class="line">  ;</span><br /><span class="line">  ; Deinstall my XMS hook. This can be done IF AND ONLY IF my XMS header</span><br /><span class="line">  ; still contains the near jump dispatch</span><br /><span class="line">  ;</span><br /><span class="line"></span><br /><span class="line">        cmp     byte ptr [MyXMSControlFunc],0EBh</span><br /><span class="line">        jne     CantDeinstallError</span><br /><span class="line">        mov     al,0EBh</span><br /><span class="line">        mov     ah,[PrevXMSControlJmpVal]</span><br /><span class="line">        les     bx,[PrevXMSControlBase]</span><br /><span class="line">        cli                             ; Disable INTs in case someone calls</span><br /><span class="line">                                        ;       XMS at interrupt time</span><br /><span class="line">        mov     word ptr es:[bx],ax</span><br /><span class="line">        mov     word ptr es:[bx+2],9090h</span><br /><span class="line">        mov     byte ptr es:[bx+4],90h</span><br /><span class="line">        sti</span><br /><span class="line"></span><br /><span class="line">    ....</span><br /></pre>
  
  
  


      </article>

    </section>

  </body>

</html>

